<section>
  <div class="gp_thumb">
    <%= image_tag thumb_image_path(@vol, :hl), class: "" %>
  </div>
  <h1>
    <%= @vol.title %>
    <small>
      <%= link_to @vol.resource do %>
        <span class="glyphicon glyphicon-download-alt"></span> 下载
      <% end %>
    </small>
  </h1>

  <div class="gp_tags" id="j_tags">
    <% @tags.each do |tag| %>
      <a class="label label-default j_tag" href="javascript:;" title="认同此标签"><%= tag.name %></a>
    <% end %>
    <span class="form-inline">
      <span style="display:none;">
        <input type="text" class="form-control input-sm">
        <button class="btn btn-default btn-sm" data-post-url="<%= volume_tags_url(@vol) %>">添加</button>
      </span>
      <a class="label label-primary" id="j_addtag" href="javascript:;">增加标签</a>
    </span>
  </div>

  <p>
    <blockquote>
      <%= @vol.desc %>
    </blockquote>
  </p>
  <section>
    <%= @vol_content %>
  </section>
</section>

<% content_for :main_title, "#{@vol.title}" %>

<%= content_for :javascripts do %>
  <script type="text/javascript">

    $(function(){
      var btnAddTag = $('#j_addtag');
      var elemTagForm = btnAddTag.siblings();
      var btnConfirmTag = elemTagForm.find('button');
      var inputTag = elemTagForm.find('input');
      var elemTags = $('#j_tags');
      btnAddTag.on('click', function(){
        elemTagForm.show();
        btnAddTag.hide();
      });
      btnConfirmTag.on('click', function(){
        var val = inputTag.val();
        var btn = $(this);
        btn.button('loading');
        $.post(btn.data('post-url'), { tag: val }, function(){
          btn.button('reset');
          elemTags.prepend(val);
        })
      });
    });


    $(function(){
      var listCards = $('#j_cards');
      var itemsCards = listCards.find('li');

      var timeline = <%= @timelines.map { |t| t.at_time } %>;
      var currentTime;  
      
      // jplayer init
      $("#j_player").jPlayer({
        ready: function () {
          $(this).jPlayer("setMedia", {
            mp3: "<%= @vol.resource %>"
          });
        },
        cssSelectorAncestor: '#j_player_ui',
        solution: 'flash, html',
        swfPath: "/jplayer.swf",
        supplied: "mp3",

        // events
        timeupdate: function(e){
          // console.log(e.jPlayer.status.currentTime); // 250ms
          // console.log(e.jPlayer.status.duration); // buffer
          var time = parseInt(e.jPlayer.status.currentTime);
          if(time === currentTime) return;

          currentTime = time;

          var matchIndex = getMatchIndex(currentTime);
          console.log('match: '+matchIndex);
          if( matchIndex !== -1 ){
            var currentItem = itemsCards.eq(matchIndex);
            currentItem.addClass('active').siblings().removeClass('active');
            sCards.scrollToElement(currentItem[0], 1200, null, true, IScroll.utils.ease.circular)
          }
        }
      });

      function getMatchIndex(currentTime){
        for(var i in timeline){
          if(parseInt(currentTime) == timeline[i]){
            return i;
          }
        }
        return -1;
      }    
    });

    // onload for the iscroll, it must get all width and height
    window.onload = function(){
      // scorllbar init
      var iscrollconfig = {
        scrollbars: true,
        mouseWheel: true,
        interactiveScrollbars: true,
        shrinkScrollbars: 'scale',
        fadeScrollbars: true
      };

      var sContainer = new IScroll('#j_container', iscrollconfig);
      var sCards = new IScroll('#j_cardsContainer', iscrollconfig);
      var sSide = new IScroll('#j_sidebar', iscrollconfig);

      document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
    };
  </script>
<% end %>
